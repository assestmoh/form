<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
<meta charset="utf-8"/>
<title>Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background: #f7f7f7;
        padding: 20px;
        direction: rtl;
    }
    h2 { text-align: center; }
    .form-section {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        position: relative;
    }
    label { display: block; margin-top: 10px; }
    input, select, textarea {
        width: 100%;
        padding: 10px;
        margin-top: 5px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-family: inherit;
        box-sizing: border-box;
    }
    textarea { resize: vertical; }
    table {
        width: 100%;
        margin-top: 20px;
        border-collapse: collapse;
    }
    table, th, td { border: 1px solid #ccc; }
    th, td { padding: 10px; text-align: center; }
    .button {
        padding: 10px 20px;
        margin: 10px 5px 0 0;
        border: none;
        border-radius: 5px;
        color: white;
        font-size: 16px;
        cursor: pointer;
    }
    .blue { background-color: #007bff; }
    .orange { background-color: #fd7e14; }
    .grey { background-color: #6c757d; }
    .warning { color: red; font-weight: bold; margin-top: 10px; }
    #signature {
        margin-top: 40px;
        text-align: left;
        font-weight: bold;
        font-size: 14px;
        color: #333;
    }
    .send-row { background-color: #d4edda; }
    .receive-row { background-color: #d1ecf1; }
    .hint { display:block; margin-top:6px; color:#666; font-size:12px; }
</style>
</head>
<body>

<h2>Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</h2>

<div class="form-section">
    <label for="actionType">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:</label>
    <select id="actionType">
        <option value="">-- Ø§Ø®ØªØ± --</option>
        <option value="Ø¥Ø±Ø³Ø§Ù„">Ø¥Ø±Ø³Ø§Ù„</option>
        <option value="Ø§Ø³ØªÙ„Ø§Ù…">Ø§Ø³ØªÙ„Ø§Ù…</option>
    </select>

    <label for="personName">Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ:</label>
    <input id="personName" type="text"/>

    <label for="date">Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
    <input id="date" type="date"/>

    <label for="organization">Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ø³Ø³Ø© :</label>
    <input id="organization" type="text"/>

    <label for="company">Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚:</label>
    <input id="company" type="text"/>

    <table>
        <tr>
            <th>Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø§Ø²</th>
            <th>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ</th>
            <th>Ø§Ù„Ø¹Ø¯Ø¯</th>
        </tr>
        <tr>
            <td><input id="deviceType" type="text"/></td>
            <td><input id="serialNumber" type="text"/></td>
            <td><input id="quantity" min="1" type="number"/></td>
        </tr>
    </table>

    <h3>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</h3>
    <textarea id="notes" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ù‡Ù†Ø§..." rows="4"></textarea>

    <!-- Ø§Ù„Ù…Ø±ÙÙ‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) -->
    <label for="attachment">Ø¥Ø±ÙØ§Ù‚ Ù…Ù„Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
    <input type="file" id="attachment" accept=".pdf,.jpg,.jpeg,.png">
    <span class="hint">ÙŠÙ…ÙƒÙ† ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºÙ‹Ø§ â€” Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ù‚ØªØ±Ø­ 5MB</span>

    <div class="warning" id="warningMessage"></div>

    <button class="button blue"   onclick="submitForm()">Ø­ÙØ¸</button>
    <button class="button orange" onclick="showTracking()">ØªØªØ¨Ø¹</button>
    <button class="button grey"   onclick="printTracking()">Ø·Ø¨Ø§Ø¹Ø©</button>

    <div id="signature">
        Ù‚Ø³Ù… Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ
    </div>
</div>

<div class="form-section" id="trackingSection" style="display:none;">
    <h3>Ù„ÙˆØ­Ø© ØªØªØ¨Ø¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</h3>
    <label>Ø¨Ø­Ø« Ø¨Ø§Ù„Ø³ÙŠØ±ÙŠØ§Ù„:</label>
    <input id="searchSerial" type="text" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø³ÙŠØ±ÙŠØ§Ù„ Ø«Ù… Ø§Ø¶ØºØ· ØªØªØ¨Ø¹"/>

    <table id="trackingTable">
        <thead>
            <tr>
                <th>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                <th>Ø§Ù„Ø§Ø³Ù…</th>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø§Ø²</th>
                <th>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ</th>
                <th>Ø§Ù„Ø¹Ø¯Ø¯</th>
                <th>Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</th>
                <th>Ø§Ù„Ø³Ø§Ø¦Ù‚</th>
                <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                <th>Ø§Ù„Ù…Ø±ÙÙ‚</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
const GET_DATA_URL = "https://script.google.com/macros/s/AKfycbxoQ80F3BAbhO9eObE2UijJly9cIjyrbPJ9L96ZMYeySxH3IoY-GZHKwmha3_yls4Es/exec";

let searchVisible = false;

function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result.split(",")[1]); // base64 ÙÙ‚Ø·
        r.onerror = reject;
        r.readAsDataURL(file);
    });
}

async function submitForm() {
    const type   = document.getElementById("actionType").value;
    const name   = document.getElementById("personName").value;
    const date   = document.getElementById("date").value;
    const org    = document.getElementById("organization").value;
    const comp   = document.getElementById("company").value;
    const device = document.getElementById("deviceType").value;
    const serial = document.getElementById("serialNumber").value;
    const qty    = document.getElementById("quantity").value;
    const notes  = document.getElementById("notes").value;

    const fileInput = document.getElementById("attachment");
    const file = fileInput.files[0] || null;

    const warning = document.getElementById("warningMessage");
    warning.textContent = "";

    if (!type || !name || !date || !org || !comp || !device || !serial || !qty) {
        warning.textContent = "ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸.";
        return;
    }

    // Ø­Ø¯ Ø­Ø¬Ù… Ø§Ø®ØªÙŠØ§Ø±ÙŠ (5MB)
    const MAX_MB = 5;
    if (file && file.size > MAX_MB * 1024 * 1024) {
        warning.textContent = "Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ " + MAX_MB + "MB).";
        return;
    }

    const data = {
        type,
        name,
        date,
        org,
        comp,
        device,
        serial,
        qty,
        notes,

        // Ø§Ù„Ù…Ø±ÙÙ‚ Ø§Ø®ØªÙŠØ§Ø±ÙŠ
        fileName: file ? file.name : "",
        fileMime: file ? file.type : "",
        fileBase64: file ? await fileToBase64(file) : ""
    };

    fetch(GET_DATA_URL, {
        method: "POST",
        body: JSON.stringify(data),
        headers: { "Content-Type": "text/plain;charset=utf-8" }
    })
    .then(res => res.json())
    .then(res => {
        if (!res || !res.ok) {
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + ((res && res.error) ? res.error : "ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø±Ø¯ Ø§Ù„Ø³ÙƒØ±Ø¨Øª"));
            return;
        }
        alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­." + (res.fileUrl ? ("\nØ±Ø§Ø¨Ø· Ø§Ù„Ù…Ø±ÙÙ‚:\n" + res.fileUrl) : "\nØ¨Ø¯ÙˆÙ† Ù…Ø±ÙÙ‚"));
        clearForm();
    })
    .catch(error => {
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸");
        console.error(error);
    });
}

function clearForm() {
    document.getElementById("actionType").value   = "";
    document.getElementById("personName").value   = "";
    document.getElementById("date").value         = "";
    document.getElementById("organization").value = "";
    document.getElementById("company").value      = "";
    document.getElementById("deviceType").value   = "";
    document.getElementById("serialNumber").value = "";
    document.getElementById("quantity").value     = "";
    document.getElementById("notes").value        = "";
    document.getElementById("attachment").value   = "";
}

function showTracking() {
    const section     = document.getElementById("trackingSection");
    const tableBody   = document.querySelector("#trackingTable tbody");
    const searchInput = document.getElementById("searchSerial");

    section.style.display = "block";

    if (!searchVisible) {
        tableBody.innerHTML = "";
        searchInput.value = "";
        alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ ØªØªØ¨Ø¹Ù‡ Ø«Ù… Ø§Ø¶ØºØ· ØªØªØ¨Ø¹ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
        searchVisible = true;
        return;
    }

    const serialFilter = searchInput.value.trim();

    if (!serialFilter) {
        alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ Ø£ÙˆÙ„Ø§Ù‹.");
        return;
    }

    tableBody.innerHTML = `
        <tr>
            <td colspan="10">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª... Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</td>
        </tr>
    `;

    let url = GET_DATA_URL + `?serial=${encodeURIComponent(serialFilter)}`;

    fetch(url)
        .then(res => res.json())
        .then(data => {
            tableBody.innerHTML = "";

            if (!data.length) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="10">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø³ÙŠØ±ÙŠØ§Ù„</td>
                    </tr>
                `;
                return;
            }

            data.forEach(row => {
                const dateVal = row["Ø§Ù„ØªØ§Ø±ÙŠØ®"] || row.date;
                const dateFormatted = formatDate(dateVal);
                const tr = document.createElement("tr");

                const type  = row["Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©"] || row.type;
                const name  = row["Ø§Ù„Ø§Ø³Ù…"] || row.name;
                const dev   = row["Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø§Ø²"] || row.device;
                const ser   = row["Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ"] || row.serial;
                const qty   = row["Ø§Ù„Ø¹Ø¯Ø¯"] || row.qty;
                const org   = row["Ø§Ù„Ù…Ø¤Ø³Ø³Ø©"] || row.org;
                const comp  = row["Ø§Ù„Ø³Ø§Ø¦Ù‚"] || row.comp;
                const notes = row["Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª"] || row.notes || "";

                // Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø±ÙÙ‚ (Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯: fileUrl)
                const fileUrl = row["fileUrl"] || row.fileUrl || "";

                tr.className = type === "Ø¥Ø±Ø³Ø§Ù„"
                    ? "send-row"
                    : (type === "Ø§Ø³ØªÙ„Ø§Ù…" ? "receive-row" : "");

                const attachmentCell = fileUrl
                  ? `<a href="${fileUrl}" target="_blank" title="Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙÙ‚" style="text-decoration:none;font-size:18px;">ğŸ“</a>`
                  : `<span style="color:#999;">â€”</span>`;

                tr.innerHTML = `
                    <td>${type || ""}</td>
                    <td>${name || ""}</td>
                    <td>${dateFormatted || ""}</td>
                    <td>${dev || ""}</td>
                    <td>${ser || ""}</td>
                    <td>${qty || ""}</td>
                    <td>${org || ""}</td>
                    <td>${comp || ""}</td>
                    <td>${notes}</td>
                    <td>${attachmentCell}</td>
                `;

                tableBody.appendChild(tr);
            });
        })
        .catch(err => {
            console.error("FETCH ERROR:", err);
            tableBody.innerHTML = `
                <tr>
                    <td colspan="10">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙƒØ±Ø¨Øª: ${err}</td>
                </tr>
            `;
        });
}

function formatDate(dateStr) {
    if (!dateStr) return "";
    const d = new Date(dateStr);
    if (isNaN(d.getTime())) return dateStr;
    const year  = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day   = String(d.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

function printTracking() {
    const tracking = document.getElementById("trackingSection").innerHTML;
    const style = `
        <style>
            body { direction: rtl; font-family: Arial; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            table, th, td { border: 1px solid #ccc; }
            th, td { padding: 10px; text-align: center; }
        </style>
    `;
    const printWindow = window.open('', '', 'width=800,height=600');
    printWindow.document.write(
        `<html><head><title>Ø·Ø¨Ø§Ø¹Ø© ØªØªØ¨Ø¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</title>${style}</head><body>${tracking}</body></html>`
    );
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
    printWindow.close();
}
</script>

</body>
</html>
